---
title: 环境和mathjax导入测试
urlname: environment-and-mathjax-import
date: 2019-04-04 15:02:14
tags:
mathjax: true
---

## 我的博客现状

我自己的博客目前的状况是这样的：可以纯用mathjax，也可以纯用katex，但是本地显示会崩，推到gh-pages上也会崩。而且因为我用Travis-CI，所以远程环境和自己的环境结果可能还会有差异。

<!--more-->

`package.json`如下：

```json
{
  "name": "hexo-site",
  "version": "0.0.0",
  "private": true,
  "hexo": {
    "version": "3.7.1"
  },
  "dependencies": {
    "hexo": "^3.2.0",
    "hexo-autoprefixer": "^2.0.0",
    "hexo-deployer-git": "^1.0.0",
    "hexo-generator-archive": "^0.1.4",
    "hexo-generator-category": "^0.1.3",
    "hexo-generator-feed": "^1.2.2",
    "hexo-generator-index": "^0.2.0",
    "hexo-generator-json-content": "^3.0.1",
    "hexo-generator-search": "^2.4.0",
    "hexo-generator-seo-friendly-sitemap": "0.0.22",
    "hexo-generator-tag": "^0.2.0",
    "hexo-helper-qrcode": "^1.0.2",
    "hexo-inject": "^1.0.0",
    "hexo-math": "^3.0.4",
    "hexo-renderer-ejs": "^0.2.0",
    "hexo-renderer-less": "^1.0.0",
    "hexo-renderer-markdown-it-plus": "^1.0.4",
    "hexo-renderer-stylus": "^0.3.1",
    "hexo-server": "^0.2.0"
  }
}
```

本地环境如下：

* OS: Windows 10
* node.js: v6.10.2
* npm: 3.10.10

Travis Server环境如下：

* OS: Ubuntu 14.04.5 LTS
* node.js: v11.13.0
* npm: 6.7.0

上面的重点可能是我用hexo-renderer-markdown-it-plus渲染markdown（按照[在material-x上使用KaTeX](https://www.micdz.cn/article/katex-on-material-x/)一文中提到的方法，并且装了hexo-math）。

### 纯用mathjax

此时（我能想到的）配置（和不配置）内容如下：

* 在博客根目录`_config.yml`中添加

```yml
math:
  engine: 'mathjax'
```

* 在post的front-matter中添加`mathjax: true`
* 在hexo-renderer-markdown-it-plus中禁用`markdown-it-katex`插件

此时本地和远程渲染结果相同。

![本地和渲染结果](mathjax-local.png)

注意到一个事实：公式对应的字符仍然被渲染了，而且，以上面那个`r`为例，它渲染出来的HTML外层仍然叫`katex`，整个元素如下：

```html
<span class="katex">
    <span class="katex-mathml has-jax has-jax">
        <span class="MathJax_Preview" style="color: inherit; display: none;"></span>
        <span id="MathJax-Element-1-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><semantics><mrow><mi>r</mi></mrow><annotation encoding=&quot;application/x-tex&quot;>      r</annotation></semantics></math>" role="presentation" style="font-size: 115%; position: relative;"><span id="MJXc-Node-1" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-2" class="mjx-mrow"><span id="MJXc-Node-3" class="mjx-semantics"><span id="MJXc-Node-4" class="mjx-mrow"><span id="MJXc-Node-5" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.22em; padding-bottom: 0.274em;">r</span></span></span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">      r</annotation></semantics></math></span></span>
        <script type="math/mml" id="MathJax-Element-1">
            <math>
                <semantics>
                    <mrow>
                        <mi>r</mi>
                    </mrow>
                    <annotation encoding="application/x-tex">r</annotation>
                </semantics>
            </math>
        </script>
    </span>
    <span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span></span>
    </span>
</span>
```

以及我建议作者把`mathjax.ejs`里的那句`console.log("mathjax did loaded!");`删掉，不然有时候一打开网页就出来三百多条log，令人很困惑。。。

### 纯用KaTeX

我大胆猜测KaTeX是全局引用的（毕竟是放到renderer里面了……）。因此，为了防止mathjax被用到，我进行了以下配置：

* 在博客根目录`_config.yml`中添加

```yml
math:
  engine: 'katex'
```

* 在post的front-matter中添加`mathjax: false`（不过好像保持为`true`也没有什么风险）
* 在hexo-renderer-markdown-it-plus中启用`markdown-it-katex`插件
* 引入最新版KaTeX CSS：

```yml
import:
  link:
    - "<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css'>"
```

此时本地和远程渲染结果也相同：

![katex渲染效果](katex-local.png)

此时渲染出来的HTML看起来变简洁了：

```html
<span class="katex">
    <span class="katex-mathml">
        <math>
            <semantics>
                <mrow>
                    <mi>r</mi>
                </mrow>
                <annotation encoding="application/x-tex">r</annotation>
            </semantics>
        </math>
    </span>
    <span class="katex-html" aria-hidden="true">
        <span class="base">
            <span class="strut" style="height:0.43056em;vertical-align:0em;"></span>
            <span class="mord mathdefault" style="margin-right:0.02778em;">r</span>
        </span>
    </span>
</span>
```

## 为什么会出现问题？

几种猜测：

* MathJax版本为2.7.1，太旧了（×）
  * 也不是没有这种可能。
* 本地nodejs和npm的版本太旧了（×）
  * 但是远程渲染也有问题。
* hexo-renderer-markdown-it-plus默认包含KaTeX，和MathJax不兼容（？）
  * 这也许可以解释为什么渲染出来都是`katex-block`
  * 不过KaTeX自己居然也渲染不好……
* hexo-renderer-markdown-it-plus这个渲染器有问题（√）
  * 很有可能。也许我应该换一个渲染器
* 作者的有些CSS设置和MathJax冲突了（×）
  * 网上好像有过这样的说法。
* 博客的`_config.yml`中设置的math engine和renderer冲突了（×）
  * 令人深思的想法
* 博客安装的包之间有冲突（？）

## 实验材料

相关文段如下（备用）：

我们重新考虑一下半径的问题。以半径$r$作为随机变量，则随机点落在$r$范围内的概率分布为

$$\text{CDF}(r) = \frac{r^2}{R^2}$$

$$\text{PDF}(r) = \frac{d}{dr} \text{CDF}(r) = \frac{2r}{R^2}$$

以`[0, 1]`均匀分布对$\text{CDF}(r)$进行随机，则有$r = R \sqrt{\text{rand}()}$。

## 实验1：hexo-renderer-marked + mathjax（默认配置）

此时同样的公式显示没有任何问题：

![看到正确的公式渲染，真欣慰……](test1.png)

结论：作者写的应该没什么问题。

---

package.json：

```json
{
  "name": "hexo-site",
  "version": "0.0.0",
  "private": true,
  "hexo": {
    "version": "3.8.0"
  },
  "dependencies": {
    "hexo": "^3.3.0",
    "hexo-autoprefixer": "^1.0.0",
    "hexo-generator-archive": "^0.1.2",
    "hexo-generator-category": "^0.1.2",
    "hexo-generator-feed": "^1.2.2",
    "hexo-generator-index": "^0.1.2",
    "hexo-generator-json-content": "^3.0.1",
    "hexo-generator-search": "^2.4.0",
    "hexo-generator-seo-friendly-sitemap": "0.0.22",
    "hexo-generator-tag": "^0.1.1",
    "hexo-helper-qrcode": "^1.0.2",
    "hexo-lazyload-image": "^1.0.3",
    "hexo-related-popular-posts": "^3.0.3",
    "hexo-renderer-ejs": "^0.3.0",
    "hexo-renderer-less": "^0.2.0",
    "hexo-renderer-marked": "^0.3.0",
    "hexo-renderer-stylus": "^0.3.0",
    "hexo-deployer-git": "^0.3.1",
    "hexo-server": "^0.2.0"
  }
}
```

`_config.yml`中没有关于mathjax的特殊配置。

## 实验2：hexo-renderer-markdown-it-plus

卸载hexo-renderer-marked，安装[hexo-renderer-markdown-it-plus](https://github.com/CHENXCHEN/hexo-renderer-markdown-it-plus)。

### 实验2.1：hexo-renderer-markdown-it-plus + mathjax

在配置文件中disable KaTeX（但不加入关于math engine的配置），如上文。其余配置不变。

![渲染挂了，而且挂得和之前一样](test2.png)

发现渲染挂了，而且挂得和之前一样。

结论：hexo-renderer-markdown-it-plus会直接导致mathjax渲染出问题。

### 实验2.2：hexo-renderer-markdown-it-plus + katex

在配置文件中enable KaTeX（但不加入关于math engine的配置），并引入最新版KaTeX CSS，如上文。其余配置不变。

![出现了一点错位](markdown-it-plus-test2.png)

发现渲染出现了一点错位，不过比我的博客中出现的状况要好一点。

而且我发现此主题中，MathJaX渲染的公式会带个灰色的底，KaTex渲染的则不会。

是否配置math engine对结果没有影响。

结论：hexo-renderer-markdown-it-plus的katex渲染可能也有问题。

---

package.json：

```json
{
  "name": "hexo-site",
  "version": "0.0.0",
  "private": true,
  "hexo": {
    "version": "3.8.0"
  },
  "dependencies": {
    "hexo": "^3.3.0",
    "hexo-autoprefixer": "^1.0.0",
    "hexo-deployer-git": "^0.3.1",
    "hexo-generator-archive": "^0.1.2",
    "hexo-generator-category": "^0.1.2",
    "hexo-generator-feed": "^1.2.2",
    "hexo-generator-index": "^0.1.2",
    "hexo-generator-json-content": "^3.0.1",
    "hexo-generator-search": "^2.4.0",
    "hexo-generator-seo-friendly-sitemap": "0.0.22",
    "hexo-generator-tag": "^0.1.1",
    "hexo-helper-qrcode": "^1.0.2",
    "hexo-lazyload-image": "^1.0.3",
    "hexo-related-popular-posts": "^3.0.3",
    "hexo-renderer-ejs": "^0.3.0",
    "hexo-renderer-less": "^0.2.0",
    "hexo-renderer-markdown-it-plus": "^1.0.4",
    "hexo-renderer-stylus": "^0.3.0",
    "hexo-server": "^0.2.0"
  }
}
```

`_config.yml`：

```yaml
```yml
import:
  link:
    - "<link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css'>"

markdown:
  render:
    html: true
    breaks: true
    linkify: true
  plugins:
    - plugin:
      name: markdown-it-katex
      enable: true/false
    - plugin:
      name: markdown-it-mark
      enable: false
```

## 实验3：hexo-renderer-markdown-it

卸载hexo-renderer-marked，安装[hexo-renderer-markdown-it](https://github.com/hexojs/hexo-renderer-markdown-it)。

之前我用的就是这个renderer，因为它自带footnote功能。（但是它似乎无法生成TOC位置anchor，所以文章目录的链接点不动）它并没有自带KaTeX。不过我也没有特意测试过它的公式显示效果。

配置mathjax为math engine。（虽然写katex也是一样的）

![公式显示正常](markdown-it-test1.png)

发现公式显示是正常的。

在这个renderer上自己加katex实在比较麻烦，我懒得试了。

结论：hexo-renderer-markdown-it-plus加katex加出锅来了。

---

package.json：

```json
{
  "name": "hexo-site",
  "version": "0.0.0",
  "private": true,
  "hexo": {
    "version": "3.8.0"
  },
  "dependencies": {
    "hexo": "^3.3.0",
    "hexo-autoprefixer": "^1.0.0",
    "hexo-deployer-git": "^0.3.1",
    "hexo-generator-archive": "^0.1.2",
    "hexo-generator-category": "^0.1.2",
    "hexo-generator-feed": "^1.2.2",
    "hexo-generator-index": "^0.1.2",
    "hexo-generator-json-content": "^3.0.1",
    "hexo-generator-search": "^2.4.0",
    "hexo-generator-seo-friendly-sitemap": "0.0.22",
    "hexo-generator-tag": "^0.1.1",
    "hexo-helper-qrcode": "^1.0.2",
    "hexo-lazyload-image": "^1.0.3",
    "hexo-related-popular-posts": "^3.0.3",
    "hexo-renderer-ejs": "^0.3.0",
    "hexo-renderer-less": "^0.2.0",
    "hexo-renderer-markdown-it": "^3.4.1",
    "hexo-renderer-stylus": "^0.3.0",
    "hexo-server": "^0.2.0"
  }
}
```

`_config.yml`：

```yaml
math:
  engine: 'mathjax'/'katex'

# Markdown-it config
## Docs: https://github.com/celsomiranda/hexo-renderer-markdown-it/wiki
markdown:
  render:
    html: true
    breaks: true
    linkify: true
  plugins:
    - markdown-it-footnote
```

## 实验4：hexo-renderer-markdown-it + 我自己的博客

我居然忘了当初hexo-renderer-markdown-it在我自己博客上公式出了啥问题了。于是我换成hexo-renderer-markdown-it，结果连编译都编译不了，hexo-generator-feed插件出问题。在网上四处查了一圈，据说是npm和nodejs版本太低了（确实低）。然后我就升级了npm，结果还是不行，于是我就干脆把这插件先给删了。

最后我发现我忘了安装renderer了，所以什么都没渲染出来，de了半天bug，发现忘了改config了。

---

最后我发现我自己用回hexo-renderer-markdown-it之后，公式一点毛病都没有了，好得很，除了TOC点不动以外没什么大毛病。我很困惑，不过就先这样吧。

（hexo-renderer-markdown-it和hexo-renderer-markdown-it-plus能不能中和一下？？？）

## 一些测不动了的东西

我猜即使安装了hexo-math也不能就让hexo-renderer-markdown-it用katex进行渲染，所以就懒得试了。

不知道hexo-renderer-pandoc怎么样。

我大胆猜测各npm插件之间没有冲突。

……
